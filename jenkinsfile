pipeline {
    agent any
    stages {
        stage("Test") {
			steps {
				
				 slackSend (color: '#FFFF00', message: "STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
				sh 'mvn surefire:test surefire-report:report'
				
				//sh  'cd /var/lib/jenkins/workspace/junitreportgeneration/target/surefire-reports'
				//sh 'touch *.xml'
			}
		}
        stage("build") {
            steps {
				slackSend channel: 'junittesting', message: 'Build Phase running'
                 sh  'mvn -Dmaven.test.skip=true surefire-report:report'
				 sh  'sudo cp /var/lib/jenkins/workspace/junitreportgeneration/target/site/surefire-report.html /var/lib/jenkins/workspace/junitreportgeneration/surefire-report.html'
				 sh  'sudo chmod 777 /var/lib/jenkins/workspace/junitreportgeneration/surefire-report.html'
				 sh  'ls -l /var/lib/jenkins/workspace/junitreportgeneration/surefire-report.html'
            }
		}
		stage("Slack notification") {
			steps {
				slackSend (color: '#00FF00', message: "SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
				slackSend baseUrl: 'https://hooks.slack.com/services/', channel: '#junittesting', color: 'good', message: 'Jenkins Build Completed', teamDomain: 'a1devopsconsulting', tokenCredentialId: 'slackunit', username: 'Chandrakanth'
				slackUploadFile channel: '#junittesting', credentialId: 'slackunit', filePath: '*.html', initialComment: 'Test Reports'
			}
		
		}

    }
    post {
        always {
            archiveArtifacts "target/**/*"
            junit '**/surefire-reports/*.xml' 
         }  
        }
		failure {
			slackSend (color: '#FF0000', message: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
			
			emailext (
				subject: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
				body: """<p>FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
            <p>Check console output at &QUOT;<a href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>&QUOT;</p>""",
				recipientProviders: [[$class: 'DevelopersRecipientProvider']]
			  )
		}
    }			